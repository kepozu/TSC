<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>m = 4(1 + Σkᵢ) - Σ(4kᵢnᵢ/dᵢ)</title>
    <style>
        /* Google Style Guide adherence notes:
         - Use kebab-case for CSS class names.
         - Keep lines under 80-100 characters where practical.
         - Add comments for non-obvious logic, explaining the 'why'.
         - Use CSS variables for theming and maintainability.
        */

        :root {
            --font-family: 'system-ui', -apple-system, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            
            /* Light Theme (Pastel) */
            --color-bg: #f0f4f8;
            --color-bg-gradient-start: #e0e7ff;
            --color-bg-gradient-end: #c7d2fe;
            --color-text: #1e293b;
            --color-text-muted: #64748b;
            --color-card-bg: #ffffff;
            --color-card-shadow: rgba(100, 116, 139, 0.1);
            --color-input-bg: #f8fafc;
            --color-input-border: #cbd5e1;
            --color-input-focus-border: #6366f1;
            --color-primary: #6366f1;
            --color-primary-text: #ffffff;
            --color-reset-bg: #fda4af;
            --color-reset-text: #9f1239;
            --color-warning: #f97316;
            --color-divider: #e2e8f0;
            --color-app-bar-bg: rgba(255, 255, 255, 0.7);
        }

        html[data-theme='dark'] {
            /* Dark Theme (Pastel) */
            --color-bg: #1e293b;
            --color-bg-gradient-start: #1e3a8a;
            --color-bg-gradient-end: #312e81;
            --color-text: #e2e8f0;
            --color-text-muted: #94a3b8;
            --color-card-bg: #334155;
            --color-card-shadow: rgba(0, 0, 0, 0.2);
            --color-input-bg: #475569;
            --color-input-border: #64748b;
            --color-input-focus-border: #818cf8;
            --color-primary: #818cf8;
            --color-primary-text: #1e293b;
            --color-reset-bg: #7f1d1d;
            --color-reset-text: #fecaca;
            --color-warning: #fb923c;
            --color-divider: #475569;
            --color-app-bar-bg: rgba(30, 41, 59, 0.7);
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            color-scheme: light dark;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated Gradient Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            background: linear-gradient(
                135deg,
                var(--color-bg-gradient-start),
                var(--color-bg-gradient-end)
            );
            background-size: 400% 400%;
            animation: gradient-animation 15s ease infinite;
            transition: background 0.5s ease;
        }

        @keyframes gradient-animation {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .app-container {
            width: 100%;
            max-width: 420px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .app-bar {
            background-color: var(--color-app-bar-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            border: 1px solid var(--color-divider);
            margin-bottom: 0.5rem;
        }

        .card {
            background-color: var(--color-card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px var(--color-card-shadow);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        /* Animation for showing/hiding elements */
        .hidden {
            opacity: 0;
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0;
            margin-bottom: 0;
            visibility: hidden;
            transform: translateY(-10px);
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .input-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-muted);
        }

        input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--color-input-border);
            background-color: var(--color-input-bg);
            color: var(--color-text);
            font-size: 1rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            -moz-appearance: textfield; /* Firefox */
        }
        
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--color-input-focus-border);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-input-focus-border) 25%, transparent);
        }

        .error-message {
            color: var(--color-reset-text);
            background-color: color-mix(in srgb, var(--color-reset-bg) 50%, transparent);
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            margin-top: 0.25rem;
            display: none; /* Initially hidden */
        }
        
        input.invalid {
            border-color: var(--color-reset-bg);
        }
        
        input.invalid:focus {
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-reset-bg) 25%, transparent);
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        button {
            flex-grow: 1;
            padding: 0.8rem 1rem;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-primary-text);
        }
        .btn-primary:not(:disabled):hover {
            filter: brightness(1.1);
        }

        .btn-reset {
            background-color: var(--color-reset-bg);
            color: var(--color-reset-text);
        }
        .btn-reset:not(:disabled):hover {
            filter: brightness(1.1);
        }

        #added-groups-display h3 {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
        }

        #added-groups-list {
            list-style: none;
            padding-left: 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        #added-groups-list li {
            background-color: var(--color-input-bg);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid var(--color-primary);
        }

        #result-display {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        #result-display.is-fallback {
            color: var(--color-warning);
        }

        /* Verification / Details section */
        details {
            border: 1px solid var(--color-divider);
            border-radius: 0.75rem;
            overflow: hidden;
        }
        
        summary {
            padding: 0.75rem 1.25rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            list-style: none; /* Remove default marker */
        }
        
        summary::-webkit-details-marker {
            display: none; /* Chrome */
        }

        summary::before {
            content: 'ℹ️';
        }

        .verification-content {
            padding: 0 1.25rem 1.25rem 1.25rem;
            border-top: 1px solid var(--color-divider);
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            word-break: break-all;
            color: var(--color-text-muted);
        }
        
        .verification-content .warning-title {
            font-weight: bold;
            color: var(--color-warning);
        }
        .verification-content .warning-text {
            color: var(--color-warning);
        }

        footer {
            margin-top: 2rem;
            text-align: center;
            font-size: 0.8rem;
            color: var(--color-text-muted);
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-bar">m = 4(1 + Σkᵢ) - Σ(4kᵢnᵢ/dᵢ)</header>

        <main>
            <!-- Input Card -->
            <section class="card">
                <form id="input-form">
                    <div class="input-grid">
                        <div class="input-group">
                            <label for="numerator-input">Numerator (分子)</label>
                            <input type="number" id="numerator-input" placeholder="e.g., 3" min="1" required>
                            <div class="error-message" id="numerator-error"></div>
                        </div>
                        <div class="input-group">
                            <label for="denominator-input">Denominator (分母)</label>
                            <input type="number" id="denominator-input" value="4" min="1" required>
                            <div class="error-message" id="denominator-error"></div>
                        </div>
                        <div class="input-group full-width">
                            <label for="count-input">Measure (連続小節数)</label>
                            <input type="number" id="count-input" value="1" min="1" required>
                            <div class="error-message" id="count-error"></div>
                        </div>
                    </div>
                    <div class="button-group">
                        <button type="submit" class="btn-primary" id="add-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                            Add (拍子の追加)
                        </button>
                    </div>
                </form>
            </section>

            <!-- Added Groups Card -->
            <section class="card hidden" id="added-groups-card">
                <div id="added-groups-display">
                    <h3>Signature Groups (追加した拍子グループ):</h3>
                    <ul id="added-groups-list"></ul>
                </div>
            </section>

            <!-- Result Card -->
            <section class="card hidden" id="result-card">
                <div id="result-display"></div>
            </section>

            <!-- Verification Panel -->
            <details class="hidden" id="verification-panel">
                <summary>Verify Logic</summary>
                <div class="verification-content" id="verification-display"></div>
            </details>

            <!-- Action Buttons -->
            <div class="button-group">
                <button id="calculate-button" class="btn-primary" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z"></path><path d="M7 7h2v2H7z"></path><path d="M11 7h2v2h-2z"></path><path d="M15 7h2v2h-2z"></path><path d="M7 11h2v2H7z"></path><path d="M11 11h2v2h-2z"></path><path d="M15 11h2v2h-2z"></path><path d="M7 15h2v2H7z"></path><path d="M11 15h2v2h-2z"></path><path d="M15 15h2v2h-2z"></path></svg>
                    Run (計算)
                </button>
                <button id="reset-button" class="btn-reset" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                    Reset (リセット)
                </button>
            </div>
        </main>

        <footer>
            version 0.0.1(beta-html_forked), Developed by Kyo@
        </footer>
    </div>

    <script>
        // Use strict mode for better error handling
        'use strict';

        // Wait for the DOM to be fully loaded before running the script
        document.addEventListener('DOMContentLoaded', () => {

            // --- State ---
            // List of added measure groups: [{numerator: int, denominator: int, count: int}]
            let addedGroups = [];

            // --- DOM Element References ---
            const inputForm = document.getElementById('input-form');
            const numeratorInput = document.getElementById('numerator-input');
            const denominatorInput = document.getElementById('denominator-input');
            const countInput = document.getElementById('count-input');
            
            const numeratorError = document.getElementById('numerator-error');
            const denominatorError = document.getElementById('denominator-error');
            const countError = document.getElementById('count-error');

            const addButton = document.getElementById('add-button');
            const calculateButton = document.getElementById('calculate-button');
            const resetButton = document.getElementById('reset-button');

            const addedGroupsCard = document.getElementById('added-groups-card');
            const addedGroupsList = document.getElementById('added-groups-list');
            
            const resultCard = document.getElementById('result-card');
            const resultDisplay = document.getElementById('result-display');
            
            const verificationPanel = document.getElementById('verification-panel');
            const verificationDisplay = document.getElementById('verification-display');

            // --- Helper Functions ---

            /**
             * Validates if an input field contains a positive integer.
             * @param {HTMLInputElement} field The input field to validate.
             * @param {HTMLElement} errorElement The element to display the error message.
             * @returns {boolean} True if valid, false otherwise.
             */
            const validateInput = (field, errorElement) => {
                const value = field.value;
                const fieldLabel = field.previousElementSibling.textContent || 'Field';
                let errorMessage = '';

                if (!value) {
                    errorMessage = `${fieldLabel}: 値が必要です`;
                } else if (!/^\d+$/.test(value)) {
                    errorMessage = `${fieldLabel}: 整数でなければなりません`;
                } else if (parseInt(value, 10) <= 0) {
                    errorMessage = `${fieldLabel}: 0より大きい値が必要です`;
                }

                errorElement.textContent = errorMessage;
                if (errorMessage) {
                    errorElement.style.display = 'block';
                    field.classList.add('invalid');
                    return false;
                }
                
                errorElement.style.display = 'none';
                field.classList.remove('invalid');
                return true;
            };
            
            /**
             * Clears the error message for an input field on change.
             * @param {Event} e The input event.
             */
            const clearErrorOnChange = (e) => {
                const field = e.target;
                const errorElement = field.nextElementSibling;
                if (errorElement && errorElement.classList.contains('error-message')) {
                    errorElement.style.display = 'none';
                    field.classList.remove('invalid');
                }
            };

            /**
             * Updates the UI based on the current application state.
             */
            const updateUI = () => {
                const hasGroups = addedGroups.length > 0;
                
                // Toggle visibility of the added groups card
                addedGroupsCard.classList.toggle('hidden', !hasGroups);

                // Enable/disable action buttons
                calculateButton.disabled = !hasGroups;
                resetButton.disabled = !hasGroups;
                
                // Clear results when groups are modified
                resultCard.classList.add('hidden');
                verificationPanel.classList.add('hidden');
                verificationPanel.open = false;
            };

            // --- Core Calculation Logic ---

            /**
             * Calculates compensation, mirroring the Python logic.
             * @returns {{result: object, userDenominator: number, explanation: string[], fallbackUsed: boolean}}
             */
            const calculateCompensation = () => {
                if (addedGroups.length === 0) {
                    return { result: {}, userDenominator: 4, explanation: ["エラー: グループが追加されていません。"], fallbackUsed: false };
                }

                let total_s = 0;
                let total_k = 0;
                const explanation = [];
                let fallbackUsed = false;

                // Find the most common denominator
                const denominators = addedGroups.map(g => g.denominator);
                const denomCounts = denominators.reduce((acc, d) => {
                    acc[d] = (acc[d] || 0) + 1;
                    return acc;
                }, {});
                const userDenominator = parseInt(Object.keys(denomCounts).reduce((a, b) => denomCounts[a] > denomCounts[b] ? a : b), 10);

                explanation.push("計算ステップ:");
                explanation.push("--------------------");
                explanation.push("追加グループ:");
                addedGroups.forEach((group, i) => {
                    const { numerator, denominator, count } = group;
                    // Convert to quarter note beats for calculation
                    const group_s = Math.floor((numerator * 4 * count) / denominator);
                    explanation.push(`  グループ ${i + 1}: ${numerator}/${denominator}拍子 x ${count}小節 -> ${group_s}拍 (4分音符換算)`);
                    total_s += group_s;
                    total_k += count;
                });

                explanation.push("--------------------");
                explanation.push(`挿入合計小節数 (Σkᵢ) = ${total_k}`);
                explanation.push(`挿入合計拍数 (S = Σ(4kᵢnᵢ/dᵢ)) = ${total_s}`);
                explanation.push("--------------------");

                // Primary Calculation: Ideal Compensation
                const ideal_m = 4 * (total_k + 1) - total_s;
                explanation.push("主要目標: 合計拍数を 4 * (合計小節数 + 1) に揃える");
                explanation.push("理想の補償拍数(m)の計算式:");
                explanation.push("  m = 4 * (1 + Σkᵢ) - Σ(4 * kᵢ * nᵢ / dᵢ)");
                explanation.push("値を代入すると:");
                explanation.push(`  m = 4 * (1 + ${total_k}) - ${total_s} = 4 * ${total_k + 1} - ${total_s} = ${ideal_m}`);

                if (ideal_m === 0) {
                    explanation.push("\n結果: 理想補償値 m = 0 のため、補償は不要です。");
                    return { result: {}, userDenominator, explanation, fallbackUsed };
                } else if (ideal_m > 0) {
                    // Case 1: Ideal compensation is positive
                    explanation.push(`\n結果: 理想補償値 m = ${ideal_m} を使用 (m > 0 のため)。`);
                    explanation.push("この拍数を効率的な小節の組み合わせに分割します。");
                    explanation.push("使用可能な拍子: 1/4 から 32/4 まで (4/4を除く)");

                    const availableNumerators = Array.from({ length: 32 }, (_, i) => 32 - i).filter(n => n !== 4);
                    let remainingBeats = ideal_m;
                    const compensationMeasures = {};
                    explanation.push("\n分割計算:");

                    for (const num of availableNumerators) {
                        if (remainingBeats === 0) break;
                        if (remainingBeats >= num) {
                            const count = Math.floor(remainingBeats / num);
                            compensationMeasures[`${num}/4`] = count;
                            remainingBeats %= num;
                            explanation.push(`  ${num}/4拍子を ${count} 小節使用 (残り: ${remainingBeats}拍)`);
                        }
                    }

                    const totalBeatsFromCompensation = ideal_m - remainingBeats;
                    explanation.push("\n検証:");
                    explanation.push(`  合計補償拍数 = ${totalBeatsFromCompensation}`);
                    explanation.push(`  合計拍数 = S + 補償拍数 = ${total_s} + ${totalBeatsFromCompensation} = ${total_s + totalBeatsFromCompensation}`);
                    explanation.push(`  目標拍数 = 4 * (Σkᵢ + 1) = 4 * (${total_k} + 1) = ${4 * (total_k + 1)}`);
                    if ((total_s + totalBeatsFromCompensation) === 4 * (total_k + 1)) {
                        explanation.push("  合計拍数が目標値と一致し、タイムラインが揃います。");
                    } else {
                        explanation.push("  検証不一致 - ロジックを確認してください。");
                    }
                    return { result: compensationMeasures, userDenominator, explanation, fallbackUsed };
                } else { // ideal_m < 0
                    // Case 2: Fallback logic for excess beats
                    fallbackUsed = true;
                    explanation.push(`\n結果: 理想値 m (${ideal_m}) が正でないため、フォールバックロジックを使用。`);
                    explanation.push("\nフォールバック目標: 追加の小節を挿入し、全体の拍数を「4拍子 x 全小節数」に揃える。");

                    const excessBeats = total_s - (4 * total_k);
                    explanation.push("\n超過拍数の計算 (4/4拍子基準):");
                    explanation.push(`  超過拍数 = S - 4*Σkᵢ = ${total_s} - 4*${total_k} = ${excessBeats}`);
                    explanation.push("この超過拍数を、4/4より短い拍子（3/4, 2/4, 1/4）を追加することで吸収します。");
                    explanation.push("  - 1/4拍子を1小節追加すると、3拍吸収 (4-1=3)");
                    explanation.push("  - 2/4拍子を1小節追加すると、2拍吸収 (4-2=2)");
                    explanation.push("  - 3/4拍子を1小節追加すると、1拍吸収 (4-3=1)");

                    let remainder = excessBeats;
                    const n_1_4 = Math.floor(remainder / 3);
                    remainder %= 3;
                    const n_2_4 = Math.floor(remainder / 2);
                    remainder %= 2;
                    const n_3_4 = remainder;

                    const suggestion = {};
                    if (n_1_4 > 0) suggestion['1/4'] = n_1_4;
                    if (n_2_4 > 0) suggestion['2/4'] = n_2_4;
                    if (n_3_4 > 0) suggestion['3/4'] = n_3_4;

                    explanation.push("\n提案の計算:");
                    explanation.push(`  1/4拍子の数 (3拍吸収): ${excessBeats} // 3 = ${n_1_4}`);
                    explanation.push(`  (残り: ${excessBeats % 3})`);
                    explanation.push(`  2/4拍子の数 (2拍吸収): ${excessBeats % 3} // 2 = ${n_2_4}`);
                    explanation.push(`  (残り: ${(excessBeats % 3) % 2})`);
                    explanation.push(`  3/4拍子の数 (1拍吸収): ${(excessBeats % 3) % 2} // 1 = ${n_3_4}`);

                    const s_add = (1 * n_1_4) + (2 * n_2_4) + (3 * n_3_4);
                    const k_add = n_1_4 + n_2_4 + n_3_4;
                    const s_new = total_s + s_add;
                    const k_new = total_k + k_add;

                    explanation.push("\n検証:");
                    explanation.push(`  提案する追加小節: ${JSON.stringify(suggestion)}`);
                    explanation.push(`  追加拍数 S_add = ${s_add}`);
                    explanation.push(`  追加小節数 k_add = ${k_add}`);
                    explanation.push(`  新合計拍数 S_new = S + S_add = ${total_s} + ${s_add} = ${s_new}`);
                    explanation.push(`  新合計小節数 k_new = Σkᵢ + k_add = ${total_k} + ${k_add} = ${k_new}`);
                    explanation.push(`  目標拍数 = 4 * k_new = 4 * ${k_new} = ${4 * k_new}`);
                    if (s_new === 4 * k_new) {
                        explanation.push("  S_new と 4 * k_new が一致し、タイムラインが整います。");
                    } else {
                        explanation.push("  検証不一致 - ロジックを確認してください。");
                    }
                    return { result: suggestion, userDenominator, explanation, fallbackUsed };
                }
            };

            // --- Event Handlers ---

            /**
             * Handles the 'Add Group' form submission.
             * @param {Event} e The submit event.
             */
            const handleAddGroup = (e) => {
                e.preventDefault(); // Prevent form from reloading the page

                const isNumeratorValid = validateInput(numeratorInput, numeratorError);
                const isDenominatorValid = validateInput(denominatorInput, denominatorError);
                const isCountValid = validateInput(countInput, countError);

                if (!isNumeratorValid || !isDenominatorValid || !isCountValid) {
                    return;
                }

                const numerator = parseInt(numeratorInput.value, 10);
                const denominator = parseInt(denominatorInput.value, 10);
                const count = parseInt(countInput.value, 10);

                if (numerator === denominator) {
                    numeratorError.textContent = "分子と分母は同じにできません";
                    numeratorError.style.display = 'block';
                    numeratorInput.classList.add('invalid');
                    return;
                }

                // Add group to state
                addedGroups.push({ numerator, denominator, count });

                // Update UI
                const listItem = document.createElement('li');
                listItem.textContent = `• ${numerator}/${denominator}拍子 × ${count}小節`;
                addedGroupsList.appendChild(listItem);

                // Reset input form
                numeratorInput.value = '';
                denominatorInput.value = '4';
                countInput.value = '1';
                numeratorInput.focus();

                updateUI();
            };

            /**
             * Handles the 'Calculate' button click.
             */
            const handleCalculate = () => {
                if (addedGroups.length === 0) return;

                const { result, userDenominator, explanation, fallbackUsed } = calculateCompensation();

                // Format result text
                let resultText = '';
                resultDisplay.classList.toggle('is-fallback', fallbackUsed);

                if (fallbackUsed) {
                    const suggestionParts = [];
                    if (result['3/4']) suggestionParts.push(`${result['3/4']}小節の3/4拍子`);
                    if (result['2/4']) suggestionParts.push(`${result['2/4']}小節の2/4拍子`);
                    if (result['1/4']) suggestionParts.push(`${result['1/4']}小節の1/4拍子`);
                    
                    if (suggestionParts.length === 0) {
                        resultText = "結果: 追加の小節は不要ですが、タイムラインは超過状態です。";
                    } else {
                        resultText = "結果: 補償として以下を追加します\n" + suggestionParts.join("と");
                    }
                    resultText += "\n⚠️ フォールバックロジックで計算";
                } else {
                    const measureKeys = Object.keys(result);
                    if (measureKeys.length === 0) {
                        resultText = "結果: 補償の必要はありません (0/4)";
                    } else {
                        const sortedKeys = measureKeys.sort((a, b) => parseInt(b.split('/')[0], 10) - parseInt(a.split('/')[0], 10));
                        const parts = sortedKeys.map(key => `${result[key]}小節の${key}拍子`);
                        resultText = "結果: 補償として以下を追加します\n" + parts.join("と");

                        if (measureKeys.length === 1 && userDenominator !== 4) {
                            const [numStr, denStr] = measureKeys[0].split('/');
                            const num = parseInt(numStr, 10);
                            if ((num * userDenominator) % 4 === 0) {
                                const userNumerator = (num * userDenominator) / 4;
                                if (userNumerator > 0) {
                                    resultText += ` (または${userNumerator}/${userDenominator}拍子)`;
                                }
                            }
                        }
                    }
                }
                resultDisplay.textContent = resultText;
                resultCard.classList.remove('hidden');

                // Populate and display verification logic
                verificationDisplay.innerHTML = ''; // Clear previous content
                verificationDisplay.textContent = explanation.join('\n');

                if (fallbackUsed) {
                    const warningHtml = `
                        <hr style="border: none; border-top: 1px solid var(--color-divider); margin: 1rem 0;">
                        <div class="warning-title">⚠️ フォールバックロジックで計算されました</div>
                        <div class="warning-text">理想補償が0以下でした。超過した拍数を吸収するために、追加の小節を提案するフォールバックロジックを適用しました。</div>
                        <br>
                        <div class="warning-text">注意: この方法は、挿入された拍数が多すぎる(S ≥ 4*(Σkᵢ+1))場合に使用されます。タイムラインを「合計拍数 = 4 × 合計小節数」という形に整えるため、4/4拍子より短い小節の追加を提案します。</div>
                    `;
                    verificationDisplay.innerHTML += warningHtml;
                    verificationPanel.open = true;
                } else {
                    verificationPanel.open = false;
                }
                verificationPanel.classList.remove('hidden');
            };

            /**
             * Handles the 'Reset' button click.
             */
            const handleReset = () => {
                // Reset state
                addedGroups = [];

                // Reset UI
                inputForm.reset(); // Resets form fields to their initial values
                numeratorInput.value = ''; // Clear numerator specifically
                denominatorInput.value = '4';
                countInput.value = '1';
                
                [numeratorError, denominatorError, countError].forEach(el => el.style.display = 'none');
                [numeratorInput, denominatorInput, countInput].forEach(el => el.classList.remove('invalid'));

                addedGroupsList.innerHTML = '';
                
                updateUI(); // This will hide cards and disable buttons
                
                numeratorInput.focus();
            };
            
            /**
             * Handles theme switching based on system preference.
             */
            const handleThemeChange = () => {
                const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
                document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            };

            // --- Event Listeners ---
            inputForm.addEventListener('submit', handleAddGroup);
            calculateButton.addEventListener('click', handleCalculate);
            resetButton.addEventListener('click', handleReset);
            
            // Clear errors on input
            [numeratorInput, denominatorInput, countInput].forEach(input => {
                input.addEventListener('input', clearErrorOnChange);
            });
            
            // Set initial theme and listen for changes
            handleThemeChange();
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', handleThemeChange);
        });
    </script>
</body>
</html>